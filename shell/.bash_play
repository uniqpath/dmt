#!/bin/bash

function m {
  declare -a opts=(
    "search"
    "play"
    "pause"
    "add"
    "volume"
    "add_shuffled"
    "list"
    "next"
    "info"
  )

  local host=""
  if [[ "$1" == @* ]]; then
    host="$1"
    shift
  fi

  if [ "$1" == "-h" ]; then
    printf "${YELLOW}Usage:${NC}\n"
    printf "${GREEN}${opts[@]}${NC}\n"
    return
  fi

  local matching_opt=''
  opts_matcher matching_opt "$1" "${opts[@]}"
  if [ $? -ne 0 ]; then # error
    matching_opt="info"
  fi

  shift

  local playerCmd="$DMT_NODE_CORE/dmt-controller/cli/music.js"

  if [ -z "$host" ]; then
    node "$playerCmd" "${matching_opt}" "$@"
  else
    node "$playerCmd" "${host}" "${matching_opt}" "$@"
  fi
}

function alsastore {
  alsactl --file ~/.config/asound.state store
}

function alsarestore {
  alsactl --file ~/.config/asound.state restore
}

function pl {
  play "$@"
}

function play {

  local audio_cmd="mpv --no-video --volume 60"

  # AUDIO
  if [ -z "$1" ] || [ "$1" == "mp3" ] || [ "$1" == "flac" ] || [ "$1" == "ogg" ]; then
    local ext="$1"

    if [ -z "$ext" ]; then
      local count=`ls -1 *.flac 2>/dev/null | wc -l`
      if [ $count -eq 0 ]; then
        count=`ls -1 *.ogg 2>/dev/null | wc -l`
        if [ $count -eq 0 ]; then
          ext="mp3"
        else
          ext="ogg"
        fi
      else
        ext="flac"
      fi
    fi

    eval "$audio_cmd *.$ext"
    return
  fi

  # MOSTLY VIDEO

  local matching_file=''
  get_matching_file matching_file "$1"
  matching_file=$(sed "s/111SINGLE___QUOTE111/'/g" <<< "$matching_file")

  if [ -f "$matching_file" ]; then
    if [[ "$matching_file" =~ (mkv|avi|mp4|webm)$ ]]; then
      printf "${YELLOW}$matching_file${NC}\n"
      if is_rpi; then
        omxplayer --vol -2000 --aspect-mode stretch -o alsa:hw:0,0 "$matching_file"
        #omxplayer --aspect-mode stretch -o alsa:hw:1,0 "$matching_file"
      else
        DISPLAY=:0 mpv --fullscreen "$matching_file"
      fi
    elif [[ "$matching_file" =~ (mp3|flac|ogg)$ ]]; then # ADUIO
      printf "${YELLOW}$matching_file${NC}\n"
      eval "$audio_cmd \"$matching_file\""
    fi
  else
    printf "${RED}No matching file${NC}\n"
    # if [[ "$1" =~ youtube ]]; then
    #   DISPLAY=:0 mpv --fullscreen "$1"
    # else
    #   DISPLAY=:0 mpv --fullscreen "https://www.youtube.com/watch?v=$1"
    # fi
  fi
}

function soundtest {
  if [ "$1" == "mp3" ]; then
    which mpv > /dev/null 2>&1

    if [ $? -eq 0 ]; then
      printf "${GREEN}Playing...${NC}\n"
    else
      printf "${MAGENTA}mpv is missing, installing...${NC}\n"
      sudo apt-get update
      sudo apt-get -y install mpv
      printf "\n${GREEN}Playing...${NC}\n"
    fi

    mpv --no-video "$DMT_PATH/etc/soundtest/soundtest.mp3"
  else
    aplay "$DMT_PATH/etc/soundtest/soundtest.wav"
  fi
}


#!/bin/bash

function search {
  local searchCmd="$DMT_NODE_CORE/dmt-controller/cli/search.js"
  node "$searchCmd" "$@"
}

function s {
  search "$@"
}

function walksearch {
  local walksearch=''
  platform_bin_command walksearch "walksearch"
  if [ -z "$walksearch" ]; then
    return
  fi
  "$walksearch" "$@"
}

function walkdir {
  local walkdir=''
  platform_bin_command walkdir "walkdir"
  if [ -z "$walkdir" ]; then
    return
  fi

  "$walkdir" "$@"
}

function update_catalogs {

  printf "${RED}Red Warning ('_') ignores not yet implemented, whole ~ is being indexed...${NC}\n"

  local device_name=''
  get_current_device device_name
  if [ -z "$device_name" ]; then
    printf "${RED}Device name not found in device.def or device.def not found ${NC}\n"
    return
  fi

  local CATALOGS_PATH="$HOME/.dmt/user/catalogs/${device_name}"
  mkdir -p "$CATALOGS_PATH"

  if [ -f "${CATALOGS_PATH}/catalog_in_progress.txt" ]; then
    rm "${CATALOGS_PATH}/catalog_in_progress.txt"
  fi

  local walkdir=''
  platform_bin_command walkdir "walkdir"
  if [ -z "$walkdir" ]; then
    return
  fi

  printf "${YELLOW}Updating or creating catalog...${NC}\n"

  time "$walkdir" ~ | grep -v -i ".DS_Store" | grep -v -i "cache" > "${CATALOGS_PATH}/catalog_in_progress.txt"

  if [ -f "${CATALOGS_PATH}/catalog_in_progress.txt" ]; then
    local cwd="`pwd`"
    cd "$CATALOGS_PATH"

    local cat_name="${device_name}.catalog"

    mv "catalog_in_progress.txt" "${cat_name}.txt"
    zip "${cat_name}.zip" "${cat_name}.txt"

    cd "$cwd"
  fi
}
